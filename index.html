<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Арбузный Кликер</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --main: #13ff7c;
      --main2: #43ffd6;
      --main3: #eaff00;
      --main4: #fff;
      --dark: #1a1a2a;
      --dark2: #161624;
      --bg1: #0b1822;
      --bg2: #141a28;
      --glow: 0 0 28px #13ff7c, 0 0 44px #43ffd6, 0 0 7px #eaff00;
      --glow-gold: 0 0 32px #ffe066, 0 0 80px #fffa95;
      --glow-btn: 0 0 24px #43ffd6, 0 0 44px #eaff00;
      --radius: 20px;
    }
    html, body {margin:0;padding:0;height:100vh;overflow:hidden;}
    body {
      background: linear-gradient(130deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
      user-select: none;
      font-family: 'Segoe UI', 'Arial', 'Verdana', sans-serif;
      color: var(--main4);
    }
    /* Welcome */
    #welcome-time {
      position: absolute; top: 18px; right: 32px; z-index: 10;
      font-size: 30px; font-weight: 900; letter-spacing: 2.5px;
      color: var(--main3);
      background: linear-gradient(90deg,#232e58 40%,#1a3c2f 100%);
      border-radius: 0 26px 0 26px;
      box-shadow: var(--glow), 0 0 12px #fffbe799;
      text-shadow: 0 0 18px #eaff00, 0 2px 16px #00ffc6, 0 0 2px #fff;
      padding: 12px 36px 8px 36px;
      min-width: 200px;
      min-height: 38px;
      user-select: none;
      pointer-events: none;
      transition: background .8s, box-shadow .7s;
      animation: welcome-glow 2.7s infinite alternate;
    }
    @keyframes welcome-glow {
      0% { box-shadow: var(--glow), 0 0 12px #fffbe799;}
      100% { box-shadow: 0 0 90px #fff700, 0 0 20px #00ffc6, 0 0 60px #eaff00; }
    }
    /* Счетчик */
    #counter {
      position: absolute; top: 32px; left: 42px; z-index: 4;
      font-size: 30px; font-weight: 900; letter-spacing:2px;
      background: linear-gradient(90deg,#13ff7c33 40%,#eaff0033 100%);
      border-radius: 0 18px 18px 0;
      color: #fff;
      text-shadow: 0 0 18px #13ff7c, 0 2px 12px #eaff00;
      box-shadow: 0 0 24px #13ff7c80;
      padding: 14px 38px 12px 28px;
      user-select: none;
      border-left: 5px solid #eaff00;
      border-top: 2px solid #43ffd6;
    }
    /* Кликер */
    #clicker {
      position: absolute; left: 50%; top: 53%; z-index: 3;
      transform: translate(-50%, -50%) scale(1);
      width: 230px;
      filter: drop-shadow(0 0 40px #13ff7c) drop-shadow(0 0 80px #eaff00cc);
      cursor: pointer;
      transition: transform .18s cubic-bezier(.7,0,0,1), filter .22s;
      animation: clicker-float 2.5s infinite alternate;
      user-select: none;
    }
    @keyframes clicker-float {
      from {transform: translate(-50%,-50%) scale(1);}
      to {transform: translate(-50%,-52%) scale(1.04);}
    }
    #clicker:active {
      transform: translate(-50%, -50%) scale(1.12) rotate(-2deg);
      filter: drop-shadow(0 0 60px #fffbe7) drop-shadow(0 0 110px #13ff7c);
    }
    /* Кнопки */
    #upgrade-btn, #settings-btn {
      position: absolute; bottom: 22px; z-index: 5;
      font-size: 20px; font-weight: bold; border-radius: var(--radius);
      border: none; outline: none;
      padding: 13px 36px; margin: 0 8px;
      background: linear-gradient(100deg,#1a3c2f 10%,#232e58 100%);
      color: #eaff00; text-shadow: 0 2px 8px #fff, 0 0 4px #00ffc6;
      box-shadow: var(--glow-btn);
      cursor: pointer;
      transition: background .18s, box-shadow .14s, transform .13s;
      filter: brightness(1.15);
      user-select: none;
      animation: btn-glow 2.2s infinite alternate;
    }
    @keyframes btn-glow {
      0% {box-shadow: var(--glow-btn);}
      100% {box-shadow: 0 0 38px #eaff00cc, 0 0 22px #13ff7c;}
    }
    #upgrade-btn { left: 35px; }
    #settings-btn { right: 35px;}
    #upgrade-btn:hover, #settings-btn:hover {
      filter: brightness(1.17) saturate(1.14);
      transform: scale(1.09);
      box-shadow: 0 0 56px #13ff7c, 0 0 54px #eaff00;
      background: linear-gradient(100deg,#2e8460 10%,#3d4699 100%);
    }
    /* Меню улучшений */
    #upgrade-menu {
      position: absolute; bottom: -100%; left: 0; width: 100%; height: 470px;
      background: linear-gradient(120deg,#1a1a2aee 10%,#0b1822ee 100%);
      color: #fffbe7; z-index: 8; padding: 30px 30px 20px 30px;
      box-sizing: border-box; border-top: 3px solid #13ff7c;
      transition: bottom 0.48s cubic-bezier(.7,0,.2,1);
      overflow-y: auto; user-select: none;
      box-shadow: 0 0 54px #43ffd688;
      border-radius: 32px 32px 0 0;
    }
    #upgrade-menu.active { bottom: 0; }
    #close-upgrades {
      position: absolute; top: 10px; right: 30px; background: transparent;
      border: none; font-size: 32px; color: #eaff00; cursor: pointer;
      user-select: none;
      text-shadow: 0 0 8px #eaff00, 0 0 12px #13ff7c;
      transition: color .18s;
    }
    #close-upgrades:hover { color: #13ff7c; }
    #upgrade-menu h2 {
      margin-top: 0; color: #eaff00; font-size: 29px;
      font-weight: 900; user-select: none; padding-left: 6px;
      text-shadow: 0 0 8px #eaff00, 0 0 18px #13ff7c;
    }
    .upgrade-item {
      display: flex; align-items: center; margin-bottom: 22px;
      background: linear-gradient(110deg,#232e58 58%,#1a3c2f 100%);
      padding: 13px 18px; border-radius: 18px;
      box-shadow: 0 0 18px #13ff7c77, 0 0 8px #eaff0055;
      border: 2px solid #13ff7c88;
      min-height: 74px;
      user-select: none;
      transition: box-shadow .18s, border-color .17s;
    }
    .upgrade-item img {
      width: 55px; height: 55px; margin-right: 19px; border-radius: 14px;
      box-shadow: 0 0 16px #13ff7c88; user-select: none; pointer-events: none;
    }
    .upgrade-info { flex-grow: 1; }
    .upgrade-info h3 {
      margin: 0 0 5px 0; font-size: 22px; color: #eaff00; font-weight: 900; user-select: none;
      text-shadow: 0 0 8px #eaff00, 0 0 18px #13ff7c;
    }
    .upgrade-info p {
      margin: 0; font-size: 15px; color: #f0ffd7; user-select: none; text-shadow: 0 0 5px #13ff7c55;
    }
    .upgrade-buy {
      background: linear-gradient(120deg, #13ff7c 40%, #eaff00 100%);
      border: none; padding: 10px 18px;
      font-weight: bold; font-size: 17px; border-radius: 9px;
      cursor: pointer; color: #293d2d; box-shadow: 0 0 8px #eaff00;
      user-select: none; transition: background .13s, box-shadow .13s;
    }
    .upgrade-buy:disabled {
      background: #232e58; color: #eaff0044;
      cursor: default; box-shadow: none; border: 1px solid #eaff0033;
    }
    .upgrade-buy:hover:not(:disabled) {
      background: linear-gradient(120deg, #eaff00 40%, #13ff7c 100%);
      color: #1c1700;
      box-shadow: 0 0 20px #eaff00, 0 0 8px #13ff7c;
    }
    /* Настройки */
    #settings-menu {
      position: absolute; top: 49%; left: 50%; transform: translate(-50%,-50%);
      min-width: 275px; background: #232e58f7; color: #eaff00; z-index: 20;
      border-radius: 22px; box-shadow: 0 0 34px #13ff7c, 0 0 4px #eaff00;
      padding: 28px 33px 24px 33px;
      display: none; flex-direction: column; align-items: flex-start;
      font-size: 18px; font-family: Arial,sans-serif; user-select: text !important;
      animation: settings-fade 0.5s;
    }
    @keyframes settings-fade { from { opacity:0; transform:scale(0.92);} to {opacity:1; transform:scale(1);} }
    #settings-menu.active { display: flex; }
    #close-settings {
      position: absolute; top: 10px; right: 25px;
      background: transparent; border: none; font-size: 34px;
      color: #eaff00; cursor: pointer; user-select: none;
      text-shadow: 0 0 10px #eaff00, 0 0 18px #13ff7c;
      transition: color .16s;
    }
    #close-settings:hover { color: #13ff7c; }
    .settings-title {
      margin-top: 0; color: #eaff00; font-size: 25px; font-weight:900;
      user-select: none; text-shadow: 0 0 8px #eaff00, 0 0 16px #13ff7c;
    }
    .settings-row {
      margin-bottom: 18px; display: flex; align-items: center;
      user-select: none;
    }
    .slider-num {
      padding: 0 10px; font-size: 18px;
      color: #13ff7c; min-width: 32px; display: inline-block; text-align: center;
      font-weight: bold; text-shadow: 0 0 3px #eaff00;
    }
    .switch {
      position: relative; display: inline-block; width: 48px; height: 26px; margin-right: 12px;
    }
    .switch input {display:none;}
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #293d2d;
      border-radius: 25px;
      transition: .3s;
      box-shadow: 0 0 7px #13ff7c88;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px; width: 20px; left: 3px; bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: .3s;
      box-shadow: 0 0 5px #13ff7c99;
    }
    input:checked + .slider {
      background: linear-gradient(90deg,#13ff7c,#eaff00 90%);
      box-shadow: 0 0 16px #13ff7c;
    }
    input:checked + .slider:before {
      transform: translateX(22px);
      background: #eaff00;
    }
    .fun-fact {
      margin: 8px 0 0 0; font-size: 15px;
      color: #fffbe7; font-style: italic;
      background: #232e5866; border-radius: 7px;
      padding: 6px 10px 5px 10px; user-select: text;
      box-shadow: 0 0 8px #13ff7c;
      text-shadow: 0 0 5px #eaff00;
    }
    /* Оффлайн доход */
    #offline-banner {
      display: none; position: fixed; left: 50%; top: 20%;
      transform: translate(-50%,0); z-index: 1000;
      background: linear-gradient(120deg,#232e58 10%,#1a3c2f 100%);
      color: #eaff00; padding: 36px 46px 34px 46px;
      border-radius: 28px; box-shadow: 0 0 42px #eaff00, 0 0 64px #13ff7c;
      text-align: center; font-size: 23px; font-weight: 900;
      border: 2px solid #13ff7c;
      animation: banner-pop .7s;
    }
    @keyframes banner-pop { from{opacity:0;transform:scale(0.92) translate(-50%,0);} to{opacity:1;transform:scale(1) translate(-50%,0);} }
    #offline-banner button {
      background: linear-gradient(90deg, #eaff00 40%, #13ff7c 100%);
      color: #1a3c2f;
      border: 0; font-size: 20px; padding: 12px 34px; border-radius: 12px;
      font-weight: bold; cursor: pointer; box-shadow: 0 0 12px #eaff00;
      margin-top: 18px; transition: background .18s;
    }
    #offline-banner button:hover {
      background: linear-gradient(90deg, #13ff7c 40%, #eaff00 100%);
      color: #232e58;
      box-shadow: 0 0 18px #13ff7c;
    }
    .particle {
      text-shadow: 0 0 22px #13ff7c, 0 0 10px #eaff00, 0 0 6px #fff;
      animation-timing-function: cubic-bezier(.33,.7,.41,1.3);
    }
    .particle.auto {
      color: #fffbe7 !important;
      text-shadow: 0 0 24px #eaff00, 0 0 18px #13ff7c, 0 0 10px #fff;
    }
    .particle.auto sup {
      color: #eaff00;
    }
    .golden-arbuz {
      position: absolute;
      z-index: 7;
      cursor: pointer;
      width: 65px;
      height: 65px;
      filter: brightness(2.3) hue-rotate(40deg) drop-shadow(0 0 32px #ffe066);
      animation: golden-appear .7s cubic-bezier(.4,0,.2,1), golden-pulse 1.2s infinite alternate;
      pointer-events: auto;
      transition: transform 0.17s;
      opacity: 1;
    }
    @keyframes golden-appear {
      from {opacity:0;transform:scale(0.7);}
      to {opacity:1;transform:scale(1);}
    }
    @keyframes golden-pulse {
      from { filter: brightness(1.9) hue-rotate(23deg) drop-shadow(0 0 29px #ffe066);}
      to   { filter: brightness(2.9) hue-rotate(70deg) drop-shadow(0 0 74px #ffe066);}
    }
    .golden-arbuz:active {
      transform: scale(1.22);
      filter: brightness(3.0) hue-rotate(90deg) drop-shadow(0 0 50px #ffe066);
    }
  </style>
</head>
<body>
  <canvas class="bg"></canvas>
  <div id="counter">Арбузики: 0</div>
  <img src="assets/click.png" id="clicker" alt="Арбуз" />
  <div id="welcome-time"></div>
  <button id="upgrade-btn">Улучшения</button>
  <button id="settings-btn">Настройки</button>
  <div id="upgrade-menu" aria-label="Меню улучшений" role="dialog" aria-modal="true">
    <button id="close-upgrades" aria-label="Закрыть меню улучшений">×</button>
    <h2>Улучшения</h2>
    <div class="upgrade-item" id="upgrade-double-click">
      <img src="assets/wm-2x.png" alt="Арбузный удвоитель" />
      <div class="upgrade-info">
        <h3>Арбузный удвоитель</h3>
        <p>Теперь за клик даётся +2 арбузика вместо +1.</p>
        <p>Стоимость: 100 арбузиков</p>
      </div>
      <button class="upgrade-buy" id="buy-double-click">Купить</button>
    </div>
    <div class="upgrade-item" id="upgrade-auto">
      <img src="assets/wm-auto.png" alt="Автоматический арбузник" />
      <div class="upgrade-info">
        <h3>Автоматический арбузник</h3>
        <p>Каждую секунду вы получаете +1 арбузик автоматически.</p>
        <p>Стоимость: 200 арбузиков</p>
      </div>
      <button class="upgrade-buy" id="buy-auto">Купить</button>
    </div>
    <div class="upgrade-item" id="upgrade-farm">
      <img src="assets/wm-farm.png" alt="Арбузная ферма" />
      <div class="upgrade-info">
        <h3>Арбузная ферма</h3>
        <p>Каждый клик приносит на 50% больше арбузиков.</p>
        <p>Стоимость: 500 арбузиков</p>
      </div>
      <button class="upgrade-buy" id="buy-farm">Купить</button>
    </div>
    <div class="upgrade-item" id="upgrade-double-power">
      <img src="assets/wm-double.png" alt="Арбузное удвоение" />
      <div class="upgrade-info">
        <h3>Арбузное удвоение</h3>
        <p>Временно удваивает прибыль за клик! Если у тебя было 6 за клик — станет 12, но если купишь ещё апгрейд на +4, будет 10, а не 20.</p>
        <p>Стоимость: 1000 арбузиков</p>
      </div>
      <button class="upgrade-buy" id="buy-double-power">Купить</button>
    </div>
    <div class="upgrade-item" id="upgrade-magnet">
      <img src="assets/wm-magnet.png" alt="Арбузный магнит" />
      <div class="upgrade-info">
        <h3>Арбузный магнит</h3>
        <p>Появляются золотые арбузы! Кликни по ним — +10 арбузиков. 25% шанс спавна раз в 5 секунд.</p>
        <p>Стоимость: 1250 арбузиков</p>
      </div>
      <button class="upgrade-buy" id="buy-magnet">Купить</button>
    </div>
    <div class="upgrade-item" id="upgrade-helper">
      <img src="assets/wm-helper.png" alt="Арбузный помощник" />
      <div class="upgrade-info">
        <h3>Арбузный помощник</h3>
        <p>Появляется автокликер, который кликает каждые 0.25 секунд.</p>
        <p>Стоимость: 3000 арбузиков</p>
      </div>
      <button class="upgrade-buy" id="buy-helper">Купить</button>
    </div>
  </div>
  <div id="offline-banner">
    <div id="offline-msg" style="font-size:22px; margin-bottom:18px;"></div>
    <button id="collect-offline">Собрать</button>
  </div>
  <div id="settings-menu" aria-label="Меню настроек" role="dialog" aria-modal="true">
    <button id="close-settings" aria-label="Закрыть меню настроек">×</button>
    <h2 class="settings-title">Настройки</h2>
    <div class="settings-row">
      <label class="switch">
        <input type="checkbox" id="toggle-debug"/>
        <span class="slider"></span>
      </label>
      <label for="toggle-debug">Показать debug-бар</label>
    </div>
    <div class="settings-row">
      <label class="switch">
        <input type="checkbox" id="toggle-funfact"/>
        <span class="slider"></span>
      </label>
      <label for="toggle-funfact">Показывать случайный факт</label>
    </div>
    <div class="settings-row">
      <label class="switch">
        <input type="checkbox" id="toggle-random-bg"/>
        <span class="slider"></span>
      </label>
      <label for="toggle-random-bg">Крутой случайный фон</label>
    </div>
    <div class="settings-row">
      <label for="bg-arbuz-count">Арбузов на фоне:</label>
      <input type="range" min="0" max="100" value="50" id="bg-arbuz-count" style="margin-left:12px;">
      <span class="slider-num" id="bg-arbuz-count-val">50</span>
    </div>
    <div class="fun-fact" id="fun-fact" style="display:none"></div>
  </div>
  <div id="debug"></div>
  <script>
    // Welcome-анимация
    const welcomeEl = document.getElementById("welcome-time");
    function getTimeStr() {
      const d = new Date();
      let h = d.getHours().toString().padStart(2,'0');
      let m = d.getMinutes().toString().padStart(2,'0');
      return h + ":" + m;
    }
    let welcomeFull = "Welcome";
    let animState = 0, animSub = 0, lastTimeStr = getTimeStr();
    function welcomeLoop() {
      if (animState === 0) { // W e l c o m e
        if (animSub < welcomeFull.length) {
          welcomeEl.textContent = welcomeFull.slice(0, animSub+1);
          animSub++;
          setTimeout(welcomeLoop, 90);
        } else {
          animState = 1; animSub = 0;
          setTimeout(welcomeLoop, 210);
        }
      } else if (animState === 1) { // Welcome |
        if (animSub <= 1) {
          welcomeEl.textContent = welcomeFull + " |";
          animSub++;
          setTimeout(welcomeLoop, 220);
        } else {
          animState = 2; animSub = 0;
          lastTimeStr = getTimeStr();
          setTimeout(welcomeLoop, 100);
        }
      } else if (animState === 2) { // Welcome | {время} по буквам
        let timeStr = getTimeStr();
        if (animSub <= timeStr.length) {
          welcomeEl.textContent = welcomeFull + " | " + timeStr.slice(0, animSub);
          animSub++;
          setTimeout(welcomeLoop, 120);
        } else {
          animState = 3; animSub = timeStr.length;
          setTimeout(welcomeLoop, 900);
        }
      } else if (animState === 3) { // Welcome | {время} стираем по буквам
        let timeStr = getTimeStr();
        if (animSub > 0) {
          welcomeEl.textContent = welcomeFull + " | " + timeStr.slice(0, animSub);
          animSub--;
          setTimeout(welcomeLoop, 50);
        } else {
          animState = 1; animSub = 0;
          setTimeout(welcomeLoop, 220);
        }
      }
    }
    welcomeLoop();

    // --- Факты для настроек ---
    const funFacts = [
      "Арбузы на 92% состоят из воды.",
      "Самый тяжёлый арбуз весил более 159 кг.",
      "Арбуз — не фрукт, а ягода.",
      "В Китае арбузы едят даже жареными!",
      "В Японии выращивают квадратные арбузы.",
      "Арбуз можно использовать как шлем — его мякоть охлаждает голову.",
      "Арбузы бывают не только красными, но и жёлтыми и даже оранжевыми!",
      "Арбуз содержит витамины A, B6 и C.",
      "Арбуз впервые начали выращивать в Африке более 5000 лет назад.",
      "В Древнем Египте арбузы клали в гробницы фараонов.",
      "В мире существует более 1200 сортов арбузов.",
      "Арбузная кожура тоже съедобна и используется в некоторых блюдах.",
      "Арбуз — один из немногих фруктов, у которого съедобны все части.",
      "В США ежегодно проводится чемпионат по плеванию семечек арбуза.",
      "Арбуз содержит аминокислоту цитруллин, полезную для сердца и сосудов."
    ];
    function showRandomFact() {
      const fact = funFacts[Math.floor(Math.random()*funFacts.length)];
      document.getElementById("fun-fact").textContent = fact;
      document.getElementById("fun-fact").style.display = "block";
      debug("Показан случайный факт");
    }
    function hideFact() {
      document.getElementById("fun-fact").style.display = "none";
      debug("Случайный факт скрыт");
    }

    // --- Дебаг ---
    let debugLog = [];
    function debug(msg) {
      if (window.debugEnabled) {
        const now = new Date();
        const stamp = now.toLocaleTimeString();
        debugLog.push(`[${stamp}] ${msg}`);
        if (debugLog.length > 12) debugLog.shift();
        document.getElementById('debug').textContent = debugLog.join('\n');
      }
      console.log('[DEBUG]', msg);
    }
    function setDebug(enabled) {
      window.debugEnabled = enabled;
      if (enabled) {
        document.body.classList.add("debug-on");
        document.getElementById('debug').style.display = "block";
        debug("debug-бар включён");
      } else {
        document.body.classList.remove("debug-on");
        document.getElementById('debug').style.display = "none";
      }
    }

    // --- Основной код ---
    window.addEventListener('DOMContentLoaded', function() {
      // Основные переменные
      let count = Number(localStorage.getItem("watermelons") || 0);
      let clickValueBase = Number(localStorage.getItem("clickValueBase") || 1); // только база!
      let clickValue = clickValueBase;
      let doublePower = localStorage.getItem("doublePower") === "true"; // Арбузное удвоение (x2)
      let autoClickerBought = localStorage.getItem("autoClickerBought") === "true";
      let helperBought = localStorage.getItem("helperBought") === "true"; // Арбузный помощник
      let doubleClickBought = localStorage.getItem("doubleClickBought") === "true";
      let farmBought = localStorage.getItem("farmBought") === "true";
      let magnetBought = localStorage.getItem("magnetBought") === "true";
      let lastClickX = null;
      let lastClickY = null;
      let autoInterval = null;
      let helperInterval = null;
      let goldenArbuz = null;
      let bgArbuzCount = Number(localStorage.getItem("bgArbuzCount") || 50);

      // Элементы DOM
      const counter = document.getElementById("counter");
      const clicker = document.getElementById("clicker");
      const upgradeBtn = document.getElementById("upgrade-btn");
      const settingsBtn = document.getElementById("settings-btn");
      const upgradeMenu = document.getElementById("upgrade-menu");
      const closeBtn = document.getElementById("close-upgrades");
      const buyDoubleClickBtn = document.getElementById("buy-double-click");
      const buyAutoBtn = document.getElementById("buy-auto");
      const buyFarmBtn = document.getElementById("buy-farm");
      const buyDoublePowerBtn = document.getElementById("buy-double-power");
      const buyMagnetBtn = document.getElementById("buy-magnet");
      const buyHelperBtn = document.getElementById("buy-helper");
      const debugDiv = document.getElementById('debug');
      const offlineBanner = document.getElementById("offline-banner");
      const offlineMsg = document.getElementById("offline-msg");
      const collectOffline = document.getElementById("collect-offline");
      const settingsMenu = document.getElementById("settings-menu");
      const closeSettings = document.getElementById("close-settings");
      const toggleDebug = document.getElementById("toggle-debug");
      const toggleFunFact = document.getElementById("toggle-funfact");
      const toggleRandomBg = document.getElementById("toggle-random-bg");
      const funFactDiv = document.getElementById("fun-fact");
      const bgArbuzSlider = document.getElementById("bg-arbuz-count");
      const bgArbuzVal = document.getElementById("bg-arbuz-count-val");

      document.body.addEventListener('copy', function(e) {
        if (!window.debugEnabled
          && !settingsMenu.classList.contains("active")
          && document.activeElement !== debugDiv
        ) e.preventDefault();
      });

      function updateClickValue() {
        let val = 1;
        if (doubleClickBought) val = 2;
        if (farmBought) val = Math.floor(val * 1.5);
        val += (clickValueBase - 1); // + всё, что было накоплено
        // doublePower применяется последним!
        clickValue = doublePower ? val * 2 : val;
      }

      function updateCounter() {
        counter.textContent = `Арбузики: ${count}`;
      }
      function saveAll() {
        localStorage.setItem("watermelons", count);
        localStorage.setItem("clickValueBase", clickValueBase);
        localStorage.setItem("autoClickerBought", autoClickerBought ? "true" : "");
        localStorage.setItem("doubleClickBought", doubleClickBought ? "true" : "");
        localStorage.setItem("farmBought", farmBought ? "true" : "");
        localStorage.setItem("magnetBought", magnetBought ? "true" : "");
        localStorage.setItem("doublePower", doublePower ? "true" : "");
        localStorage.setItem("helperBought", helperBought ? "true" : "");
        localStorage.setItem("bgArbuzCount", bgArbuzCount);
        localStorage.setItem("lastPlayed", Date.now());
      }
      function createParticle(x, y, text, isAuto = false) {
        const particle = document.createElement("div");
        particle.className = "particle";
        if (isAuto) {
          particle.classList.add("auto");
          particle.innerHTML = `${text}<sup>A</sup>`;
        } else {
          particle.textContent = text;
        }
        particle.style.left = x + "px";
        particle.style.top = y + "px";
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1000);
      }
      clicker.addEventListener("click", (e) => {
        updateClickValue();
        count += clickValue;
        updateCounter();
        saveAll();
        createParticle(e.clientX, e.clientY, "+" + clickValue);
        lastClickX = e.clientX;
        lastClickY = e.clientY;
        debug(`Клик! Получено +${clickValue}, всего: ${count}`);
        checkUpgradesAvailability();
      });

      function checkUpgradesAvailability() {
        buyDoubleClickBtn.disabled = !(count >= 100 && !doubleClickBought);
        buyAutoBtn.disabled = !(count >= 200 && !autoClickerBought);
        buyFarmBtn.disabled = !(count >= 500 && !farmBought);
        buyDoublePowerBtn.disabled = !(count >= 1000 && !doublePower);
        buyMagnetBtn.disabled = !(count >= 1250 && !magnetBought);
        buyHelperBtn.disabled = !(count >= 3000 && !helperBought);
      }
      buyDoubleClickBtn.addEventListener("click", () => {
        if (count >= 100 && !doubleClickBought) {
          count -= 100;
          doubleClickBought = true;
          updateClickValue();
          updateCounter();
          saveAll();
          buyDoubleClickBtn.disabled = true;
          buyDoubleClickBtn.textContent = "Куплено";
          debug("Улучшение куплено: Арбузный удвоитель. Клик теперь +" + clickValue);
          checkUpgradesAvailability();
        }
      });
      buyAutoBtn.addEventListener("click", () => {
        if (count >= 200 && !autoClickerBought) {
          count -= 200;
          autoClickerBought = true;
          updateClickValue();
          updateCounter();
          saveAll();
          buyAutoBtn.disabled = true;
          buyAutoBtn.textContent = "Куплено";
          debug("Улучшение куплено: Автоматический арбузник. Автокликер активен.");
          startAutoClicker();
          checkUpgradesAvailability();
        }
      });
      buyFarmBtn.addEventListener("click", () => {
        if (count >= 500 && !farmBought) {
          count -= 500;
          farmBought = true;
          updateClickValue();
          updateCounter();
          saveAll();
          buyFarmBtn.disabled = true;
          buyFarmBtn.textContent = "Куплено";
          debug("Улучшение куплено: Арбузная ферма. Клик теперь +" + clickValue);
          checkUpgradesAvailability();
        }
      });
      buyDoublePowerBtn.addEventListener("click", () => {
        if (count >= 1000 && !doublePower) {
          count -= 1000;
          doublePower = true;
          updateClickValue();
          updateCounter();
          saveAll();
          buyDoublePowerBtn.disabled = true;
          buyDoublePowerBtn.textContent = "Куплено";
          debug("Улучшение куплено: Арбузное удвоение. Клик теперь +" + clickValue + ". Новые апгрейды будут добавлять к базовой прибыли, а не к удвоенной.");
          checkUpgradesAvailability();
        }
      });
      buyMagnetBtn.addEventListener("click", () => {
        if (count >= 1250 && !magnetBought) {
          count -= 1250;
          magnetBought = true;
          updateClickValue();
          updateCounter();
          saveAll();
          buyMagnetBtn.disabled = true;
          buyMagnetBtn.textContent = "Куплено";
          debug("Улучшение куплено: Арбузный магнит. Теперь могут появляться золотые арбузы на фоне!");
          startGoldenTimer();
          checkUpgradesAvailability();
        }
      });
      buyHelperBtn.addEventListener("click", () => {
        if (count >= 3000 && !helperBought) {
          count -= 3000;
          helperBought = true;
          updateClickValue();
          updateCounter();
          saveAll();
          buyHelperBtn.disabled = true;
          buyHelperBtn.textContent = "Куплено";
          debug("Улучшение куплено: Арбузный помощник. Быстрый автокликер включён!");
          startHelperClicker();
          checkUpgradesAvailability();
        }
      });

      function initUpgrades() {
        if (doubleClickBought) {
          buyDoubleClickBtn.disabled = true;
          buyDoubleClickBtn.textContent = "Куплено";
        } else { buyDoubleClickBtn.disabled = true; }
        if (autoClickerBought) {
          buyAutoBtn.disabled = true;
          buyAutoBtn.textContent = "Куплено";
          startAutoClicker();
        } else { buyAutoBtn.disabled = true; }
        if (farmBought) {
          buyFarmBtn.disabled = true;
          buyFarmBtn.textContent = "Куплено";
        } else { buyFarmBtn.disabled = true; }
        if (doublePower) {
          buyDoublePowerBtn.disabled = true;
          buyDoublePowerBtn.textContent = "Куплено";
        } else { buyDoublePowerBtn.disabled = true; }
        if (magnetBought) {
          buyMagnetBtn.disabled = true;
          buyMagnetBtn.textContent = "Куплено";
          startGoldenTimer();
        } else { buyMagnetBtn.disabled = true; }
        if (helperBought) {
          buyHelperBtn.disabled = true;
          buyHelperBtn.textContent = "Куплено";
          startHelperClicker();
        } else { buyHelperBtn.disabled = true; }
        updateClickValue();
      }

      function startAutoClicker() {
        if (autoInterval) return;
        autoInterval = setInterval(() => {
          updateClickValue();
          count += clickValue;
          updateCounter();
          saveAll();
          let x, y;
          if (lastClickX !== null && lastClickY !== null) {
            x = lastClickX;
            y = lastClickY;
          } else {
            const rect = clicker.getBoundingClientRect();
            x = rect.left + rect.width / 2;
            y = rect.top + rect.height / 2;
          }
          createParticle(x, y, "+" + clickValue, true);
          debug(`Автоклик: +${clickValue}, всего: ${count}`);
        }, 1000);
      }
      function startHelperClicker() {
        if (helperInterval) return;
        helperInterval = setInterval(() => {
          updateClickValue();
          count += clickValue;
          updateCounter();
          saveAll();
          let x, y;
          if (lastClickX !== null && lastClickY !== null) {
            x = lastClickX + 25;
            y = lastClickY + 25;
          } else {
            const rect = clicker.getBoundingClientRect();
            x = rect.left + rect.width / 2 + 25;
            y = rect.top + rect.height / 2 + 25;
          }
          createParticle(x, y, "+" + clickValue, true);
          debug(`Помощник автокликнул: +${clickValue}, всего: ${count}`);
        }, 250);
      }

      function showOfflineIncome() {
        let lastPlayed = Number(localStorage.getItem("lastPlayed"));
        let now = Date.now();
        if (!lastPlayed || isNaN(lastPlayed)) {
          localStorage.setItem("lastPlayed", now);
          debug('Время последней игры не найдено, установлено сейчас.');
          offlineBanner.style.display = "none";
          return;
        }
        let offlineSecs = Math.floor((now - lastPlayed) / 1000);
        offlineSecs = Math.min(offlineSecs, 600); // максимум 10 минут
        let offlineReward = 0;
        updateClickValue();
        if (autoClickerBought && offlineSecs >= 10) {
          offlineReward = offlineSecs * clickValue;
          if (helperBought) offlineReward += Math.floor(offlineSecs * 4 * clickValue); // помощник!
          offlineBanner.style.display = "";
          offlineMsg.innerHTML =
            `Ты был(а) оффлайн <b>${Math.floor(offlineSecs / 60)} мин. ${offlineSecs % 60} сек.</b><br>Твой доход: <b>${offlineReward} арбузиков</b>`;
          collectOffline.onclick = function() {
            count += offlineReward;
            updateCounter();
            saveAll();
            offlineBanner.style.display = "none";
            checkUpgradesAvailability();
            debug(`Собрано оффлайн-дохода: +${offlineReward}, всего: ${count}`);
          }
          debug(`Открыто меню оффлайн-дохода: +${offlineReward} за ${offlineSecs} сек.`);
        } else {
          offlineBanner.style.display = "none";
          if (!autoClickerBought)
            debug('Нет оффлайн-дохода: автокликер не куплен');
          else if (offlineSecs < 10)
            debug('Нет оффлайн-дохода: мало времени оффлайн ('+offlineSecs+' сек)');
          else
            debug('Нет оффлайн-дохода: неизвестная причина');
        }
      }

      // Настройки
      settingsBtn.addEventListener("click", () => {
        settingsMenu.classList.add("active");
        debug("Открыто меню настроек");
      });
      closeSettings.addEventListener("click", () => {
        settingsMenu.classList.remove("active");
        debug("Закрыто меню настроек");
      });
      toggleDebug.addEventListener("change", function() {
        setDebug(this.checked);
        localStorage.setItem("debugEnabled", this.checked ? "1" : "0");
        debug("debug-бар " + (this.checked ? "включён" : "выключен"));
      });
      toggleFunFact.addEventListener("change", function() {
        if (this.checked) {
          showRandomFact();
          localStorage.setItem("funFactEnabled", "1");
        } else {
          hideFact();
          localStorage.setItem("funFactEnabled", "0");
        }
      });
      toggleRandomBg.addEventListener("change", function() {
        if (this.checked) {
          document.body.style.background =
            'radial-gradient(ellipse at center, #' +
            Math.floor(Math.random()*16777215).toString(16).padStart(6,0) +
            ' 0%, #'+
            Math.floor(Math.random()*16777215).toString(16).padStart(6,0) +
            ' 100%)';
          localStorage.setItem("randBgEnabled", "1");
          debug("Случайный фон установлен");
        } else {
          document.body.style.background =
            "radial-gradient(ellipse at center, #014421 0%, #000000 100%)";
          localStorage.setItem("randBgEnabled", "0");
          debug("Фон сброшен на стандартный");
        }
      });
      bgArbuzSlider.value = bgArbuzCount;
      bgArbuzVal.textContent = bgArbuzCount;
      bgArbuzSlider.addEventListener("input", function() {
        bgArbuzCount = +bgArbuzSlider.value;
        bgArbuzVal.textContent = bgArbuzCount;
        localStorage.setItem("bgArbuzCount", bgArbuzCount);
        debug("Изменено количество арбузов на фоне: " + bgArbuzCount);
      });

      // Инициализация опций
      if (localStorage.getItem("debugEnabled")==="1") {
        toggleDebug.checked = true;
        setDebug(true);
      }
      if (localStorage.getItem("funFactEnabled")==="1") {
        toggleFunFact.checked = true;
        showRandomFact();
      }
      if (localStorage.getItem("randBgEnabled")==="1") {
        toggleRandomBg.checked = true;
        toggleRandomBg.dispatchEvent(new Event('change'));
      }

      // Улучшения и интерфейс
      checkUpgradesAvailability();
      updateClickValue();
      updateCounter();
      initUpgrades();
      showOfflineIncome();

      window.addEventListener("beforeunload", function() {
        localStorage.setItem("lastPlayed", Date.now());
      });

      // Фоновые арбузы и золотые арбузы
      const canvas = document.querySelector(".bg");
      const ctx = canvas.getContext("2d");
      let W = canvas.width = window.innerWidth;
      let H = canvas.height = window.innerHeight;
      const bg = new Image();
      bg.src = "assets/bg.png";
      let arbs = [];
      let goldenArbuzActive = false;
      function spawnArbuzes() {
        arbs = [];
        for (let i = 0; i < bgArbuzCount; i++) {
          arbs.push({
            x: Math.random() * W,
            y: Math.random() * H,
            size: 40 + Math.random() * 50,
            speedX: -1 + Math.random() * 2,
            speedY: -1 + Math.random() * 2,
            opacity: 0.3 + Math.random() * 0.7,
            angle: Math.random() * Math.PI * 2,
            rotateSpeed: 0.005 + Math.random() * 0.01
          });
        }
      }

      // Golden Arbuz (магнит, каждые 5 секунд шанс 25%)
      let goldenTimer = null;
      function startGoldenTimer() {
        if (goldenTimer) clearInterval(goldenTimer);
        goldenTimer = setInterval(() => {
          if (!magnetBought || goldenArbuzActive) return;
          if (Math.random() < 0.25) {
            let x = Math.random() * (window.innerWidth - 60) + 20;
            let y = Math.random() * (window.innerHeight - 100) + 40;
            goldenArbuz = document.createElement('img');
            goldenArbuz.src = "assets/bg.png";
            goldenArbuz.className = "golden-arbuz";
            goldenArbuz.style.left = x + "px";
            goldenArbuz.style.top = y + "px";
            goldenArbuz.title = "+10 арбузиков!";
            goldenArbuzActive = true;
            document.body.appendChild(goldenArbuz);
            goldenArbuz.onclick = function() {
              count += 10;
              updateCounter();
              saveAll();
              createParticle(x + 20, y, "+10");
              debug("Пойман золотой арбуз! +10 арбузиков.");
              goldenArbuz.remove();
              goldenArbuzActive = false;
            }
            setTimeout(() => {
              if (goldenArbuzActive) {
                goldenArbuz.remove();
                goldenArbuzActive = false;
                debug("Золотой арбуз исчез.");
              }
            }, 3000);
          }
        }, 5000);
      }

      function draw() {
        ctx.clearRect(0, 0, W, H);
        for (let a of arbs) {
          ctx.save();
          ctx.globalAlpha = a.opacity;
          ctx.translate(a.x, a.y);
          ctx.rotate(a.angle);
          ctx.drawImage(bg, -a.size / 2, -a.size / 2, a.size, a.size);
          ctx.restore();
          a.x += a.speedX;
          a.y += a.speedY;
          a.angle += a.rotateSpeed;
          if (a.x < -100) a.x = W + 100;
          if (a.y < -100) a.y = H + 100;
          if (a.x > W + 100) a.x = -100;
          if (a.y > H + 100) a.y = -100;
        }
        requestAnimationFrame(draw);
      }
      bg.onload = function() {
        spawnArbuzes();
        draw();
      };
      window.addEventListener('resize', () => {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
        spawnArbuzes();
      });
      bgArbuzSlider.addEventListener("input", spawnArbuzes);

      upgradeBtn.addEventListener("click", () => {
        upgradeMenu.classList.add("active");
        debug("Открыто меню улучшений");
      });
      closeBtn.addEventListener("click", () => {
        upgradeMenu.classList.remove("active");
        debug("Закрыто меню улучшений");
      });
    });
  </script>
</body>
</html>
